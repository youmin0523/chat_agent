# ìƒì„¸ ë°ì´í„° íë¦„ & ë³€ìˆ˜ ì¶”ì  ê°€ì´ë“œ (Data Flow Walkthrough)

ì´ ë¬¸ì„œëŠ” í”„ë¡œì íŠ¸ì— ì¡´ìž¬í•˜ëŠ” **ëª¨ë“  ë³€ìˆ˜(Variables)**ì™€ **ìƒíƒœ(State)**ê°€ ì–´ë””ì„œ ìƒì„±ë˜ê³ , ì–´ë–»ê²Œ ë³€í•˜ë©°, ì–´ë””ì„œ ì†Œë©¸í•˜ëŠ”ì§€ **ì „ìˆ˜ ì¡°ì‚¬**í•˜ì—¬ ì •ë¦¬í•œ ë°±ê³¼ì‚¬ì „ì´ìž ë§¤ë‰´ì–¼ìž…ë‹ˆë‹¤.

---

## 1. ë³€ìˆ˜ ë°±ê³¼ì‚¬ì „ (Variable Encyclopedia)

ì½”ë“œì— ë“±ìž¥í•˜ëŠ” ëª¨ë“  ë³€ìˆ˜ì˜ ì •ì²´ì™€ ì—­í• ì„ ì •ë¦¬í–ˆìŠµë‹ˆë‹¤.

### 1-1. í”„ë¡ íŠ¸ì—”ë“œ ë³€ìˆ˜ (React)

| ë³€ìˆ˜ëª… (Variable)  | ì´ˆê¸°ê°’/ì¶œì²˜   | ë³€ê²½ ì‹œì  (Trigger)         | ì—­í•  (Role)                                   |
| :----------------- | :------------ | :-------------------------- | :-------------------------------------------- |
| **`showChatbot`**  | `true`        | í† ê¸€ ë²„íŠ¼ í´ë¦­              | ì±—ë´‡ ì°½ì˜ í‘œì‹œ ì—¬ë¶€ ì œì–´ (`useState`)         |
| **`chatHistory`**  | `[]`          | ì „ì†¡ í´ë¦­ / ì‘ë‹µ ìˆ˜ì‹        | í™”ë©´ì— í‘œì‹œë  ëŒ€í™” ëª©ë¡ ì „ì²´ (`useState`)     |
| **`chatBodyRef`**  | `null`        | ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸ ì‹œ          | ìŠ¤í¬ë¡¤ì„ ì¡°ìž‘í•  ì±„íŒ…ì°½ DOM ìš”ì†Œ (`useRef`)    |
| **`inputRef`**     | `null`        | ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸ ì‹œ          | ì‚¬ìš©ìžê°€ ê¸€ì„ ì“°ëŠ” ìž…ë ¥ì°½ DOM ìš”ì†Œ (`useRef`) |
| `userMessage`      | `input.value` | í¼ ì „ì†¡ ì‹œ (`handleSubmit`) | ì‚¬ìš©ìžê°€ ìž…ë ¥í•œ ë°©ê¸ˆ ë§‰ ì“´ í…ìŠ¤íŠ¸             |
| `formattedHistory` | `chatHistory` | API ìš”ì²­ ì§ì „               | êµ¬ê¸€ API ê·œê²©ì— ë§žì¶° ìž¬ê°€ê³µëœ ëŒ€í™” ëª©ë¡       |

### 1-2. ë°±ì—”ë“œ ë³€ìˆ˜ (FastAPI/LangChain)

| ë³€ìˆ˜ëª… (Variable)       | ì •ì˜/ì¶œì²˜     | ì—­í•  (Role)                                  |
| :---------------------- | :------------ | :------------------------------------------- |
| **`app.state.history`** | `[]`          | ì„œë²„ ë©”ëª¨ë¦¬ì— ì €ìž¥ëœ ì „ì—­ ëŒ€í™” ê¸°ë¡ (íœ˜ë°œì„±) |
| `request`               | `ChatRequest` | í´ë¼ì´ì–¸íŠ¸ê°€ ë³´ë‚¸ JSONì´ ë³€í™˜ëœ íŒŒì´ì¬ ê°ì²´  |
| `current_user_message`  | `string`      | ë³µìž¡í•œ ê°ì²´ ì†ì—ì„œ êº¼ë‚´ì˜¨ 'ì§„ì§œ ì§ˆë¬¸ í…ìŠ¤íŠ¸' |
| `system_prompt`         | `string`      | "ë„ˆëŠ” ë²•ë¥  ì „ë¬¸ê°€ì•¼"ë¼ëŠ” AI ê°€ìŠ¤ë¼ì´íŒ…(Rule) |
| `state`                 | `dict`        | LangGraph ì—ì´ì „íŠ¸ê°€ ìƒê°í•  ë•Œ ì“°ëŠ” ë©”ëª¨ìž¥   |
| `answer`                | `string`      | AIê°€ ìµœì¢…ì ìœ¼ë¡œ ìƒì„±í•œ ë‹µë³€ í…ìŠ¤íŠ¸           |

---

## 2. ë‹¨ê³„ë³„ ìƒì„¸ ë¶„ì„ (Step-by-Step Narrative)

ì´ˆë³´ìžë„ ì´í•´í•  ìˆ˜ ìžˆë„ë¡ ë°ì´í„°ê°€ í˜ëŸ¬ê°€ëŠ” ê³¼ì •ì„ ì´ì•¼ê¸°ì²˜ëŸ¼ í’€ì–´ ì”ë‹ˆë‹¤.

### Step 1: í”„ë¡ íŠ¸ì—”ë“œ - í¬ìž¥í•˜ê¸° (Formatting)

ì‚¬ìš©ìžê°€ ì—”í„°ë¥¼ ì¹˜ëŠ” ìˆœê°„(`handleSubmit`), ì½”ë“œëŠ” ë‚ ê²ƒì˜ í…ìŠ¤íŠ¸ë¥¼ ìƒìžì— ë‹´ìŠµë‹ˆë‹¤.

**ðŸ“‚ íŒŒì¼: `front/src/components/ChatForm.jsx`**

```javascript
// 1. HTML ìž…ë ¥ì°½ì—ì„œ ê°’ì„ êº¼ëƒ…ë‹ˆë‹¤.
const userMessage = inputRef.current.value.trim();
// ðŸ‘‰ ë³€ìˆ˜ ìƒíƒœ: "ì „ì„¸ ì‚¬ê¸° ì˜ˆë°©ë²•" (ë‹¨ìˆœ ë¬¸ìžì—´)

// 2. í™”ë©´ì— ë³´ì—¬ì£¼ê¸° ìœ„í•´ React ìƒíƒœ(State)ì— ì €ìž¥í•©ë‹ˆë‹¤.
setChatHistory((history) => [
  ...history,
  { role: 'user', text: userMessage }, // ðŸ‘‰ ê°ì²´(Object)ë¡œ ë³€ì‹ !
]);
```

**ðŸ“‚ íŒŒì¼: `front/src/App.jsx`**

```javascript
// 3. ì„œë²„ë¡œ ë³´ë‚´ê¸° ìœ„í•´ 'formattedHistory'ë¼ëŠ” ìƒˆë¡œìš´ í˜•íƒœë¡œ ê°€ê³µí•©ë‹ˆë‹¤.
const formattedHistory = history.map(({ role, text }) => ({
  role: role === 'user' ? 'user' : 'model',
  parts: [{ text: text }], // ðŸ‘‰ êµ¬ê¸€ ìŠ¤íƒ€ì¼ì˜ ê¹Šì€ êµ¬ì¡°ë¡œ ë‹¤ì‹œ í¬ìž¥
}));

// 4. ìµœì¢…ì ìœ¼ë¡œ JSON ë¬¸ìžì—´ë¡œ ë³€í™˜ë˜ì–´ ë„¤íŠ¸ì›Œí¬ë¥¼ íƒ‘ë‹ˆë‹¤.
body: JSON.stringify({ contents: formattedHistory });
```

> **ì„¤ëª…**: "ì „ì„¸ ì‚¬ê¸°"ë¼ëŠ” ê¸€ìžê°€ `userMessage`ë¼ëŠ” ì»µì— ë‹´ê²¼ë‹¤ê°€, `chatHistory`ë¼ëŠ” ìŸë°˜ì— ì˜¬ë¼ê°€ê³ , ë§ˆì§€ë§‰ì—” `formattedHistory`ë¼ëŠ” íƒë°° ìƒìžì— í¬ìž¥ë˜ì–´ íŠ¸ëŸ­(`fetch`)ì„ íƒ€ê³  ë– ë‚©ë‹ˆë‹¤.

---

### Step 2: ë°±ì—”ë“œ - í•´ì„í•˜ê¸° (Parsing)

ì¸í„°ë„·ì„ íƒ€ê³  ë„˜ì–´ì˜¨ JSON íƒë°°ê°€ íŒŒì´ì¬ì˜ ì„¸ê³„ë¡œ ë“¤ì–´ì˜µë‹ˆë‹¤.

**ðŸ“‚ íŒŒì¼: `back/main.py`**

```python
# 1. FastAPIê°€ JSONì„ ë°›ì•„ì„œ ë¯¸ë¦¬ ì •ì˜í•´ë‘” 'ChatRequest' ì¢…ì´ í‹€(Class)ì— ë§žì¶¥ë‹ˆë‹¤.
async def chat_endpoint(request: ChatRequest):
    # ðŸ‘‰ request ë³€ìˆ˜ëŠ” ì´ì œ ë‹¨ìˆœí•œ ê¸€ìžê°€ ì•„ë‹ˆë¼, .contentsë¡œ ì ‘ê·¼ ê°€ëŠ¥í•œ 'ê°ì²´'ê°€ ë©ë‹ˆë‹¤.

# 2. ë³µìž¡í•œ í¬ìž¥ì§€ë¥¼ ëœ¯ì–´ë‚´ê³  ì•Œë§¹ì´(í…ìŠ¤íŠ¸)ë§Œ ì™ ëºë‹ˆë‹¤.
current_user_message = request.contents[-1].parts[0].get("text", "")
# ðŸ‘‰ ë³€ìˆ˜ ìƒíƒœ: "ì „ì„¸ ì‚¬ê¸° ì˜ˆë°©ë²•" (ë‹¤ì‹œ ë‹¨ìˆœ ë¬¸ìžì—´ë¡œ ëŒì•„ì˜´!)

# 3. AI ë‡Œ(Agent)ì—ê²Œ ì´ ì•Œë§¹ì´ë¥¼ ë˜ì ¸ì¤ë‹ˆë‹¤.
response = await process_query(current_user_message, conversation_history)
```

> **ì„¤ëª…**: ì„œë²„ëŠ” íƒë°° ìƒìž(`request`)ë¥¼ ë°›ì•„ì„œ í¬ìž¥ì§€ë¥¼ ëœ¯ê³ , ê·¸ ì•ˆì— ìžˆëŠ” ì§„ì§œ ë‚´ìš©ë¬¼(`current_user_message`)ë§Œ êº¼ë‚´ì„œ AIì—ê²Œ ì „ë‹¬í•©ë‹ˆë‹¤.

---

### Step 3: AI ì—ì´ì „íŠ¸ - ìƒê°í•˜ê¸° (Reasoning)

ì´ì œ ê°€ìž¥ ë˜‘ë˜‘í•œ í•¨ìˆ˜ì¸ `agent.py`ê°€ ìž‘ë™í•©ë‹ˆë‹¤.

**ðŸ“‚ íŒŒì¼: `back/agent.py`**

```python
async def process_query(query, conversation_history):
    # 1. ì§ˆë¬¸ì„ ë¦¬ìŠ¤íŠ¸(List) í˜•íƒœì˜ ë©”ì‹œì§€ë¡œ ë§Œë“­ë‹ˆë‹¤.
    messages = [HumanMessage(content=query)]
    # ðŸ‘‰ ë³€ìˆ˜ ìƒíƒœ: [HumanMessage(content="ì „ì„¸ ì‚¬ê¸° ì˜ˆë°©ë²•")]

    # 2. LangChain ì—ì´ì „íŠ¸ê°€ ì´ ë©”ì‹œì§€ë¥¼ ë³´ê³  íŒë‹¨í•©ë‹ˆë‹¤.
    response = await agent.ainvoke({"messages": messages})
    # ðŸ¤” AIì˜ ë…ë°±: "ë²•ë¥  ì§ˆë¬¸ì´ë„¤? ê²€ìƒ‰(Search Tool)ì„ ì¢€ í•´ë´ì•¼ê² ì–´."

    # 3. ìµœì¢… ë‹µë³€ë§Œ ë½‘ì•„ëƒ…ë‹ˆë‹¤.
    answer = ai_message[-1].content
    # ðŸ‘‰ ë³€ìˆ˜ ìƒíƒœ: "ì „ì„¸ ì‚¬ê¸° í”¼í•´ë¥¼ ë§‰ìœ¼ë ¤ë©´ ê³„ì•½ ì „ì— ë“±ê¸°ë¶€ë“±ë³¸ì„..." (ê¸´ ë¬¸ìžì—´)

    return answer
```

> **ì„¤ëª…**: AIëŠ” ì§ˆë¬¸ì„ ë°›ìœ¼ë©´ ë°”ë¡œ ëŒ€ë‹µí•˜ ì§€ ì•Šê³ , "ì´ê²Œ ë¬´ìŠ¨ ì§ˆë¬¸ì´ì§€?" í•˜ê³  ìƒê°(`Reading`)í•œ ë’¤, í•„ìš”í•˜ë©´ ë„êµ¬(`Tool`)ë¥¼ ì¨ì„œ ë‹µì„ ë§Œë“¤ì–´ëƒ…ë‹ˆë‹¤.

---

### Step 4: ë°˜í™˜ (Return Trip)

ë§Œë“¤ì–´ì§„ ë‹µë³€ì€ ì™”ë˜ ê¸¸ì„ ê±°ìŠ¬ëŸ¬ ì˜¬ë¼ê°€ ì‚¬ìš©ìžì—ê²Œ ë„ì°©í•©ë‹ˆë‹¤.

1. `agent.py`ê°€ `answer` ë¬¸ìžì—´ ë°˜í™˜
2. `main.py`ê°€ `ChatResponse` ê°ì²´(`{"text": answer}`)ë¡œ ìž¬í¬ìž¥
3. `App.jsx`ê°€ ë°›ì•„ì„œ `setChatHistory`ë¡œ í™”ë©´ ì—…ë°ì´íŠ¸
4. ì‚¬ìš©ìžëŠ” í™”ë©´ì—ì„œ ë‹µë³€ í™•ì¸ ì™„ë£Œ!

---

## 3. ìƒíƒœ ë³€í™” íƒ€ìž„ë¼ì¸ (State Transition Timeline)

í•µì‹¬ ìƒíƒœ ë³€ìˆ˜ì¸ **`chatHistory`**ê°€ ì‹œê°„ íë¦„ì— ë”°ë¼ ì–´ë–»ê²Œ ë³€í•˜ëŠ”ì§€ ì¶”ì í•©ë‹ˆë‹¤.

**ìƒí™©: ì‚¬ìš©ìžê°€ "ì•ˆë…•"ì´ë¼ê³  ìž…ë ¥í–ˆì„ ë•Œ**

1.  **ì´ˆê¸° ìƒíƒœ (Initial)**
    - `chatHistory`: `[]`

2.  **ì‚¬ìš©ìž ìž…ë ¥ ì§í›„ (`handleSubmit`)**
    - `setChatHistory([...history, {role: 'user', text: 'ì•ˆë…•'}])` ì‹¤í–‰
    - `chatHistory`: `[{role: 'user', text: 'ì•ˆë…•'}]`
    - ðŸ›‘ **í™”ë©´ ê°±ì‹  1**: ì‚¬ìš©ìžì˜ ë§í’ì„ ì´ í™”ë©´ì— ë³´ìž„.

3.  **ë¡œë”© í‘œì‹œ (`setTimeout` ë‚´ë¶€)**
    - `setChatHistory([...history, {role: 'model', text: 'ìƒê°ì¤‘ ...'}])` ì‹¤í–‰
    - `chatHistory`: `[{role: 'user', text: 'ì•ˆë…•'}, {role: 'model', text: 'ìƒê°ì¤‘ ...'}]`
    - ðŸ›‘ **í™”ë©´ ê°±ì‹  2**: ì±—ë´‡ ë§í’ì„ ì— "ìƒê°ì¤‘ ..."ì´ ëœ¸.

4.  **API ì‘ë‹µ ìˆ˜ì‹  í›„ (`updatedHistory`)**
    - `prev.filter(...)`ë¡œ "ìƒê°ì¤‘ ..." ë©”ì‹œì§€ ì‚­ì œ
    - ìƒˆë¡œìš´ ë‹µë³€ "ë°˜ê°‘ìŠµë‹ˆë‹¤" ì¶”ê°€
    - `chatHistory`: `[{role: 'user', text: 'ì•ˆë…•'}, {role: 'model', text: 'ë°˜ê°‘ìŠµë‹ˆë‹¤'}]`
    - ðŸ›‘ **í™”ë©´ ê°±ì‹  3**: "ìƒê°ì¤‘ ..."ì´ ì‚¬ë¼ì§€ê³  ì‹¤ì œ ë‹µë³€ì´ ë³´ìž„.

---

## 4. React ì‹¬í™” ë¶„ì„: ìƒíƒœ(State)ì™€ ì†ì„±(Props)ì˜ ë§ˆë²•

Reactê°€ ì–´ë–»ê²Œ ë°ì´í„°ë¥¼ ë‹¤ë£¨ëŠ”ì§€ í¬ìŠ¤íŠ¸ìž‡ê³¼ ì‹¬ë¶€ë¦„ì— ë¹„ìœ í•´ ì„¤ëª…í•©ë‹ˆë‹¤.

### 4.1. `useState` (ë³€í•˜ëŠ” ë°ì´í„° = í¬ìŠ¤íŠ¸ìž‡)

> **"í™”ë©´ì— ë³´ì—¬ì§€ëŠ” ë‚´ìš©ì€ ì¼ë°˜ ë³€ìˆ˜ê°€ ì•„ë‹ˆë¼ ë°˜ë“œì‹œ Stateë¡œ ë§Œë“¤ì–´ì•¼ í•œë‹¤."**

1.  **ì„ ì–¸**: `chatHistory`ëŠ” í˜„ìž¬ì˜ ëŒ€í™” ëª©ë¡ì´ê³ , `setChatHistory`ëŠ” ì´ ëª©ë¡ì„ ìˆ˜ì •í•˜ëŠ” ìœ ì¼í•œ ë„êµ¬(í•¨ìˆ˜)ìž…ë‹ˆë‹¤.
2.  **ìž‘ë™ ì›ë¦¬**: ìš°ë¦¬ê°€ `userMessage` ë³€ìˆ˜ì— "ì•ˆë…•"ì„ ë‹´ëŠ”ë‹¤ê³  í™”ë©´ì´ ë°”ë€Œì§€ ì•ŠìŠµë‹ˆë‹¤. ë°˜ë“œì‹œ `setChatHistory(["ì•ˆë…•"])`ì´ë¼ê³  **ì‹ í˜¸**ë¥¼ ì¤˜ì•¼, Reactê°€ "ì•„! ë°ì´í„°ê°€ ë°”ë€Œì—ˆë„¤? í™”ë©´ì„ ë‹¤ì‹œ ê·¸ë ¤ì•¼ê² ë‹¤(Re-render)"ë¼ê³  ì¸ì‹í•©ë‹ˆë‹¤.

### 4.2. `props` (ë°ì´í„° ì „ë‹¬ = ì‹¬ë¶€ë¦„)

> **"ë¶€ëª¨(App)ê°€ ìžì‹(ChatForm)ì—ê²Œ ì£¼ëŠ” ì„ ë¬¼ ë³´ë”°ë¦¬."**

1.  **ìƒí™©**: `ChatForm`ì€ ì±„íŒ…ì„ ìž…ë ¥ë°›ëŠ” í™”ë©´ì¼ ë¿, ì‹¤ì œ ë°ì´í„°ë¥¼ ì €ìž¥í•˜ëŠ” ê³³(`chatHistory`)ì€ ë¶€ëª¨ì¸ `App`ì— ìžˆìŠµë‹ˆë‹¤.
2.  **ì „ë‹¬**: ë¶€ëª¨(`App`)ëŠ” ìžì‹ ì˜ í•¨ìˆ˜ì¸ `generateChatResponse`ì™€ `setChatHistory`ë¥¼ ìžì‹(`ChatForm`)ì—ê²Œ `props`ë¼ëŠ” ë³´ë”°ë¦¬ì— ì‹¸ì„œ ë‚´ë ¤ë³´ëƒ…ë‹ˆë‹¤.
3.  **ì‚¬ìš©**: ìžì‹(`ChatForm`)ì´ ì´ í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•˜ë©´, ì‹¤ì œë¡œëŠ” **ë¶€ëª¨(`App`)ì˜ ê³µê°„ì—ì„œ** í•¨ìˆ˜ê°€ ì‹¤í–‰ë˜ì–´ ë¶€ëª¨ì˜ ìƒíƒœ(`chatHistory`)ê°€ ë°”ë€ë‹ˆë‹¤. "ì—„ë§ˆ ì¹´ë“œë¡œ ìžì‹ì´ ê²°ì œí•˜ëŠ” ê²ƒ"ê³¼ ê°™ìŠµë‹ˆë‹¤.

### 4.3. `useEffect` (ë³€í™” ê°ì§€ = ì•Œë¦¼ ì„¤ì •)

> **"íŠ¹ì • ë°ì´í„°ê°€ ë³€í•  ë•Œë§Œ ëª°ëž˜ ì‹¤í–‰ë˜ëŠ” ë’·ì •ë¦¬ ìš”ì›."**

1.  **ëª©ì **: í™”ë©´ì´ ë‹¤ ê·¸ë ¤ì§„ **ë‹¤ìŒì—** ë¬´ì–¸ê°€ë¥¼ í•˜ê³  ì‹¶ì„ ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
2.  **ì‹œë‚˜ë¦¬ì˜¤**: ì‚¬ìš©ìžê°€ ë©”ì‹œì§€ ì „ì†¡ âž” `setChatHistory`ë¡œ ëª©ë¡ ì¶”ê°€ âž” í™”ë©´ì´ ë‹¤ì‹œ ê·¸ë ¤ì§(ë©”ì‹œì§€ ë³´ìž„) âž” **ê·¸ ì§í›„ì—** `useEffect`ê°€ ë°œë™ âž” ìŠ¤í¬ë¡¤ì„ ì­ˆìš± ë‚´ë ¤ì„œ ìƒˆ ë©”ì‹œì§€ë¥¼ ë³´ì—¬ì¤Œ.

---

## 5. ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ëž¨ (Sequence Diagram)

ì „ì²´ ì‹œìŠ¤í…œì˜ ë³€ìˆ˜ ì´ë™ ê²½ë¡œë¥¼ ì‹œê°í™”í–ˆìŠµë‹ˆë‹¤.

```mermaid
sequenceDiagram
    autonumber

    box rgb(240, 248, 255) Frontend (Variables)
    participant Ref as references (input/body)
    participant State as useState (history)
    participant Local as local vars
    end

    box rgb(255, 248, 240) Backend (Variables)
    participant Memory as app.state.history
    participant Pydantic as ChatRequest
    participant Logic as agent vars
    end

    Note over Ref: User types "Hello"
    Ref->>Local: userMessage = inputRef.value
    Local->>State: setChatHistory(userMessage)<br/>(Render User Msg)
    State->>Local: formattedHistory (JSON)
    Local->>Pydantic: POST /chat (request)

    Pydantic->>Logic: current_user_message
    Memory->>Logic: conversation_history
    Logic->>Logic: messages = prompt + history + query
    Logic->>Logic: answer = LLM(messages)
    Logic->>Pydantic: ChatResponse(answer)

    Pydantic->>Local: data (JSON)
    Local->>State: updatedHistory(answer)<br/>(Render AI Msg)
    State->>Ref: chatBodyRef.scrollToBottom()
```
